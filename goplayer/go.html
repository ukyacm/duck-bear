<!DOCTYPE HTML>
<html>
<!-- THIS FILE HOLDS THE FINISHED GAME MOVE BY MOVE -->
<script src="two_moves.jsonp"></script>

<script src="http://code.jquery.com/jquery-1.9.0rc1.js"></script>
<head>
    <meta charset="UTF-8">
    <style></style>
</head>
<body>
    <canvas id="goCanvas" width="600px" height="600px">asd</canvas>
<script>
var GameState = new Object();

(function($){
        var readHTMLFile = function(url){
            var toReturn;
            $.ajax({
                url: url,
                async: false
            }).done(function(data){
                toReturn = data;
            });
            return toReturn;
        };
        $.addPanels = function(url){
            GameState = readHTMLFile(url);  
        };
     })(jQuery);

function ParseFile(){
    GameState = this.GameState.toString().split('\n');
    len = GameState.length;
    for (i = 0 ; i < len ;++i){
        currTurnData = GameState[i].split(',');
        GameState[i] = new Object();
        GameState[i]['turn'] = currTurnData[0];
        GameState[i]['p1'] = currTurnData[1];
        GameState[i]['p2'] = currTurnData[2];
        GameState[i]['Board'] = currTurnData[3];
        GameState[i]['comment'] = currTurnData[4];

        this.GameState = GameState;
    }
}

$(document).ready(function() {
    //ReadDataFromFile("hedonismbot1-hedonismbot2.game");
    $.addPanels("hedonismbot1-hedonismbot2.game");
    ParseFile();
    App.main();
});
    
App = new function() {
    Images = { 'arrow_right' : 'http://media.battlestarwiki.org/images/e/ef/Symbol_Down_Arrow.svg' };

    this.canvas = document.getElementById("goCanvas");
    this.sprites = new Array();
    // gameMoves are already held in gameMoves because the json file is included at the top
    // this.gameMoves = gameMoves;
   
    this.turn = 0;

    this.main = function() {
        this.board = new Board(9, 25, 25, 550, 550);
        this.board.markers.push({x: 5,y: 5});
        this.board.markers.push({x: 3,y: 3});
        this.board.markers.push({x: 7,y: 7});
        this.board.markers.push({x: 3,y: 7});
        this.board.markers.push({x: 7,y: 3});
        

        var spr = new Sprite(600,100,100,100,Images['arrow_right']);
        spr.onClick = function() {
            alert("clicked");
        }

        this.sprites.push(spr);
        this.canvas.addEventListener("mousedown", this.onMouseDown, false);
        this.redraw();
    }
    
    this.onMouseDown = function(evt) {
        App.turn += 1;
        for(var i = 0; i < App.sprites.length; i++)
            App.sprites[i].inject(evt.pageX,evt.pageY);
        App.redraw();
    }
    
    this.redraw = function() {
        var ctx = this.canvas.getContext("2d");
        ctx.fillStyle = "#E8E6A7";
        ctx.fillRect(0,0,this.canvas.width,this.canvas.height);
        this.board.draw(ctx);
        
        var turn = Math.min(App.turn, gameMoves.length-1);
        printBoard(turn,ctx);

        // for(var i = 0; i < this.sprites.length; i++){
        //    this.sprites[i].draw(ctx);
        // }   
    }
}

printBoard = function(turn,ctx){
    for (var i = 0 ; i < 81; i++){
        currPiece = this.GameState[turn]['Board'][i];
        if ( currPiece == "0")
            continue;

        x = i % 9;
        y = i / 9;

        if (currPiece == "1")
            GamePiece(x,y,'white',ctx);
        if (currPiece == "2")
            GamePiece(x,y,'black',ctx);
    }
}

GamePiece = function(osX, osY, color,ctx) {
    var radius = 25;
    ctx.closePath();
    ctx.beginPath();
    ctx.arc( 80+(parseInt(osX)*55), 80+(55*parseInt(osY)), radius, 0, 2 * Math.PI, false);
    ctx.fillStyle = color;
    ctx.fill();
    ctx.lineWidth = 1;
    ctx.strokeStyle = '#87a0ed';
    ctx.stroke();
    ctx.closePath();
    ctx.beginPath();
}

Sprite = function(left,top,width,height, src) {
    this.img = new Image();
    this.img.src = src;
    this.width = width;
    this.height = height;
    this.left = left;
    this.top = top;
    this.onClick = null;
    
    this.inject = function(x,y) {
        if(this.onClick != null && 
            x > this.left && x < this.left + this.width && 
            y > this.top && y < this.top + this.height)
            this.onClick();
    }
    
    this.draw = function(ctx) {
        this.img.onload = function(){
            ctx.drawImage(this, left, top, this.width, this.height);
        }
        this.img.src = src;            
    } 
}

Board = function(size,osX,osY,width,height) {
    this.size = size;
    this.osX = osX;
    this.osY = osY;
    this.width = width;
    this.height = height;
    this.cspaceX = width/(size+1);
    this.cspaceY = height/(size+1);
    this.cells = new Array(size);
    this.markers = new Array();
    
    for(var row = 0; row < size; row++) {
        this.cells[row] = new Array(size);
    }
    
    this.draw = function(ctx) {
        var cspaceX = this.width/(this.size+1);
        var cspaceY = this.height/(this.size+1);
        
        ctx.fillStyle = "#EDD487";
        ctx.fillRect(this.osX,this.osY,this.width,this.height);
    
        ctx.lineWidth = 2;
        ctx.strokeStyle = "rgba(0, 0, 0, 0.7)";
        for(var i = 1; i <= this.size; i++) {
            ctx.beginPath();
            ctx.moveTo( this.osX + this.cspaceX, 
                        this.osY + this.cspaceY * i);
            ctx.lineTo( this.osX + this.cspaceX * this.size, 
                        this.osY + this.cspaceY * i);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo( this.osX + this.cspaceX * i,
                        this.osY + this.cspaceY);
            ctx.lineTo( this.osX + this.cspaceX * i,
                        this.osY + this.cspaceY * this.size);
            ctx.stroke();
        }
        var mWidth = this.width/100;
        var mHeight = this.height/100;
        
        ctx.fillStyle = "rgba(0, 0, 0, 0.8)";
        for(var i = 0; i < this.markers.length; i++) {
            var cell = this.markers[i];
            var coord = {x: this.osX + this.cspaceX * cell.x, y: this.osY + this.cspaceY * cell.y};
            ctx.fillRect(coord.x-mWidth,coord.y-mHeight,mWidth*2,mHeight*2);
        }
    }
}


</script>
</body> 
</html>